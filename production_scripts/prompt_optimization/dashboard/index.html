<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prompt Optimization & Supabase Sync Dashboard</title>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f8fafc;
            color: #334155;
            line-height: 1.4;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 16px;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .header h1 {
            font-size: 22px;
            font-weight: 700;
            color: #0f172a;
            margin-bottom: 4px;
        }

        .glass-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .prompt-display {
            font-family: Monaco, 'Courier New', monospace;
            font-size: 0.875rem;
            line-height: 1.5;
            white-space: pre-wrap;
            background: #f8fafc;
            color: #334155;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            transition: border-color 0.3s;
        }
        .prompt-display.optimized {
            border-color: #10b981;
            background: #f0fdf4;
        }
        .changes-highlight {
            background: #10b981;
            color: white;
            padding: 2px 4px;
            border-radius: 3px;
            font-weight: bold;
            display: inline;
        }
        .toggle-switch {
            position: relative;
            width: 60px;
            height: 30px;
            background: #e2e8f0;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .toggle-switch.active {
            background: #10b981;
        }
        .toggle-slider {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            transition: all 0.3s;
        }
        .toggle-switch.active .toggle-slider {
            left: 33px;
        }
        .toggle-label {
            font-weight: 600;
            color: #64748b;
            transition: color 0.3s;
        }
        .toggle-label.active {
            color: #10b981;
        }
        .assistant-card {
            background: white;
            padding: 16px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border-left: 4px solid #3b82f6;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 12px;
        }
        .assistant-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .assistant-card.active {
            border-left-color: #10b981;
            background: #f0fdf4;
        }
        .assistant-name {
            font-weight: 600;
            color: #0f172a;
            margin-bottom: 8px;
            font-size: 14px;
        }
        .tabs {
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            gap: 0;
        }
        .tab-button {
            padding: 12px 20px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-weight: 600;
            color: #64748b;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }
        .tab-button.active {
            color: #0f172a;
            border-bottom-color: #3b82f6;
        }
    </style>
</head>
<body x-data="vapiDashboard()">

    <!-- Supabase Sync Status Header -->
    <div class="container">
        <div class="glass-card" style="background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 100%); color: white; margin-bottom: 20px;">
            <div style="padding: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <h2 style="font-size: 24px; font-weight: 700; margin: 0;">ðŸ”„ Supabase Integration Status</h2>
                    <div style="background: rgba(255,255,255,0.2); padding: 8px 16px; border-radius: 8px;">
                        <div style="font-size: 20px; font-weight: bold;">100%</div>
                        <div style="font-size: 12px; opacity: 0.9;">Success Rate</div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                    <div style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px;">
                        <div style="font-size: 18px; font-weight: bold;">11/11</div>
                        <div style="font-size: 14px; opacity: 0.9;">Records Synced</div>
                    </div>
                    <div style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px;">
                        <div style="font-size: 18px; font-weight: bold;">2.4s</div>
                        <div style="font-size: 14px; opacity: 0.9;">Processing Time</div>
                    </div>
                    <div style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px;">
                        <div style="font-size: 18px; font-weight: bold;">Sep 26, 11:27</div>
                        <div style="font-size: 14px; opacity: 0.9;">Last Sync</div>
                    </div>
                    <div style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px;">
                        <div style="font-size: 18px; font-weight: bold;">0 Errors</div>
                        <div style="font-size: 14px; opacity: 0.9;">Perfect Run</div>
                    </div>
                </div>

                <div style="margin-top: 16px; display: flex; gap: 12px; flex-wrap: wrap;">
                    <a href="https://supabase.com/dashboard/project/hyokiyktrvqgxedfpilr/editor/17434?schema=public"
                       target="_blank"
                       style="background: rgba(255,255,255,0.2); color: white; padding: 8px 16px; border-radius: 6px; text-decoration: none; font-weight: 600; font-size: 14px; transition: all 0.3s;">
                        ðŸ“Š View Supabase Table
                    </a>
                    <button onclick="alert('cd production_scripts/prompt_optimization && node sync_prompt_optimizations_to_supabase.js')"
                            style="background: rgba(255,255,255,0.2); color: white; padding: 8px 16px; border-radius: 6px; border: none; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.3s;">
                        ðŸ”„ Run Sync Again
                    </button>
                    <a href="../sync_prompt_optimizations_to_supabase.js"
                       style="background: rgba(255,255,255,0.2); color: white; padding: 8px 16px; border-radius: 6px; text-decoration: none; font-weight: 600; font-size: 14px; transition: all 0.3s;">
                        ðŸ’» View Source Code
                    </a>
                </div>
            </div>
        </div>

    <!-- Header -->
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h1 x-text="translations[language].title"></h1>
                <div style="display: flex; gap: 8px;">
                    <button @click="setLanguage('bg')"
                            style="padding: 6px 12px; border-radius: 6px; border: none; cursor: pointer; font-size: 12px; font-weight: 600;"
                            :style="language === 'bg' ? 'background: #3b82f6; color: white;' : 'background: #f1f5f9; color: #64748b;'">
                        BG
                    </button>
                    <button @click="setLanguage('en')"
                            style="padding: 6px 12px; border-radius: 6px; border: none; cursor: pointer; font-size: 12px; font-weight: 600;"
                            :style="language === 'en' ? 'background: #3b82f6; color: white;' : 'background: #f1f5f9; color: #64748b;'">
                        EN
                    </button>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="glass-card" style="padding: 20px;">
            <!-- Tab Navigation -->
            <div class="tabs" style="margin-bottom: 24px;">
                <button @click="activeTab = 'history'"
                        class="tab-button"
                        :class="activeTab === 'history' ? 'active' : ''">
                    <span x-text="translations[language].historyTab"></span>
                </button>
                <button @click="activeTab = 'analytics'"
                        class="tab-button"
                        :class="activeTab === 'analytics' ? 'active' : ''">
                    <span x-text="translations[language].analyticsTab"></span>
                </button>
                <button @click="activeTab = 'progress'"
                        class="tab-button"
                        :class="activeTab === 'progress' ? 'active' : ''">
                    <span x-text="translations[language].progressTab"></span>
                </button>
            </div>

            <!-- History Tab -->
            <div x-show="activeTab === 'history'">
                <h2 class="text-xl font-semibold mb-4" x-text="translations[language].runHistory"></h2>
                <p class="text-sm text-gray-600 mb-4">ðŸ’¡ Click on any run to view its detailed analytics</p>
                <div class="overflow-x-auto">
                    <table class="w-full border-collapse">
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="border p-2 text-left" x-text="translations[language].date"></th>
                                <th class="border p-2 text-left" x-text="translations[language].assistants"></th>
                                <th class="border p-2 text-left" x-text="translations[language].calls"></th>
                                <th class="border p-2 text-left" x-text="translations[language].avgQCI"></th>
                                <th class="border p-2 text-left" x-text="translations[language].status"></th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="run in runs" :key="run.id">
                                <tr class="hover:bg-gray-100 cursor-pointer transition-colors"
                                    :class="currentRun.id === run.id ? 'bg-blue-50 border-l-4 border-blue-500' : ''"
                                    @click="loadRun(run.id)"
                                    title="Click to load this run">
                                    <td class="border p-2" x-text="formatDate(run.timestamp)"></td>
                                    <td class="border p-2" x-text="run.assistants || '-'"></td>
                                    <td class="border p-2" x-text="run.totalCalls || '-'"></td>
                                    <td class="border p-2" x-text="run.avgQCI ? run.avgQCI.toFixed(1) : '-'"></td>
                                    <td class="border p-2">
                                        <span class="px-2 py-1 rounded text-xs"
                                              :class="run.status === 'completed' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'"
                                              x-text="run.status"></span>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>

                <div x-show="runs.length === 0" class="text-center py-8 text-gray-500">
                    <span x-text="translations[language].noRuns"></span>
                </div>
            </div>

            <!-- Analytics Tab -->
            <div x-show="activeTab === 'analytics'">
                <div x-show="!currentRun.id" class="text-center py-8 text-gray-500">
                    <span x-text="translations[language].selectRun"></span>
                </div>

                <div x-show="currentRun.id">
                    <!-- Overview Stats -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <div class="text-2xl font-bold text-blue-600" x-text="currentRun.assistants || 0"></div>
                            <div class="text-sm text-gray-600" x-text="translations[language].assistants"></div>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg">
                            <div class="text-2xl font-bold text-green-600" x-text="currentRun.totalCalls || 0"></div>
                            <div class="text-sm text-gray-600" x-text="translations[language].calls"></div>
                        </div>
                        <div class="bg-purple-50 p-4 rounded-lg">
                            <div class="text-2xl font-bold text-purple-600" x-text="currentRun.avgQCI ? currentRun.avgQCI.toFixed(1) : '0'"></div>
                            <div class="text-sm text-gray-600" x-text="translations[language].avgQCI"></div>
                        </div>
                        <div class="bg-orange-50 p-4 rounded-lg">
                            <div class="text-2xl font-bold text-orange-600" x-text="formatDate(currentRun.timestamp)"></div>
                            <div class="text-sm text-gray-600" x-text="translations[language].analyzed"></div>
                        </div>
                    </div>

                    <!-- Assistant Selector -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium mb-2" x-text="translations[language].selectAssistant"></label>
                        <select class="w-full p-2 border border-gray-300 rounded-lg" x-model="selectedAssistantId" @change="loadAssistantDetails()">
                            <option value="">-- Select Assistant --</option>
                            <template x-for="assistant in assistants" :key="assistant.id">
                                <option :value="assistant.id" x-text="`${getAssistantDisplayName(assistant)} (QCI: ${assistant.qci ? assistant.qci.toFixed(1) : 'N/A'})`"></option>
                            </template>
                        </select>
                    </div>

                    <!-- Assistant Details -->
                    <div x-show="selectedAssistant" class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- QCI Breakdown -->
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="font-semibold mb-3" x-text="translations[language].qciBreakdown"></h3>
                            <div class="space-y-2">
                                <template x-for="category in qciCategories" :key="category.name">
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm" x-text="category.name"></span>
                                        <span class="font-medium" x-text="getQCIValue(category.key)"></span>
                                    </div>
                                </template>
                            </div>
                        </div>

                        <!-- Call Stats -->
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="font-semibold mb-3" x-text="translations[language].callStats"></h3>
                            <div class="space-y-2">
                                <div class="flex justify-between">
                                    <span class="text-sm" x-text="translations[language].totalCalls"></span>
                                    <span x-text="selectedAssistant?.callCount || 0"></span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-sm" x-text="translations[language].successRate"></span>
                                    <span x-text="selectedAssistant?.successRate ? selectedAssistant.successRate + '%' : 'N/A'"></span>
                                </div>
                            </div>
                        </div>

                        <!-- Recommendations -->
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="font-semibold mb-3" x-text="translations[language].recommendations"></h3>
                            <div class="space-y-3">
                                <template x-for="rec in getRecommendations()" :key="rec.title">
                                    <div class="border-l-4 p-3 rounded"
                                         :class="{
                                             'bg-red-50 border-red-400': rec.priority === 'HIGH',
                                             'bg-yellow-50 border-yellow-400': rec.priority === 'MEDIUM',
                                             'bg-blue-50 border-blue-400': rec.priority === 'LOW'
                                         }">
                                        <div class="text-xs font-bold mb-1"
                                             :class="{
                                                 'text-red-600': rec.priority === 'HIGH',
                                                 'text-yellow-600': rec.priority === 'MEDIUM',
                                                 'text-blue-600': rec.priority === 'LOW'
                                             }"
                                             x-text="rec.priority + ' PRIORITY'"></div>
                                        <div class="font-semibold text-gray-800 mb-1" x-text="rec.title"></div>
                                        <div class="text-sm text-gray-600" x-text="rec.description"></div>
                                    </div>
                                </template>
                                <div x-show="getRecommendations().length === 0" class="text-gray-500 text-center py-4">
                                    No recommendations available
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Prompt Toggle -->
                    <div x-show="selectedAssistant?.currentPrompt" class="mt-6">
                        <div class="flex items-center gap-4 mb-4">
                            <span class="toggle-label" :class="{ 'active': !showOptimizedPrompt }" x-text="translations[language].currentPrompt"></span>
                            <div class="toggle-switch" :class="{ 'active': showOptimizedPrompt }" @click="showOptimizedPrompt = !showOptimizedPrompt">
                                <div class="toggle-slider"></div>
                            </div>
                            <span class="toggle-label" :class="{ 'active': showOptimizedPrompt }" x-text="translations[language].optimizedPrompt"></span>
                        </div>

                        <!-- Key Changes Panel -->
                        <div x-show="showOptimizedPrompt && selectedAssistant?.keyChanges?.length > 0" class="mb-4 bg-green-50 border border-green-200 rounded-lg p-4">
                            <h4 class="font-semibold text-green-800 mb-2">Key Changes Made:</h4>
                            <div class="space-y-2">
                                <template x-for="change in selectedAssistant.keyChanges" :key="change.section">
                                    <div class="text-sm">
                                        <span class="font-medium text-green-700" x-text="change.section + ':'"></span>
                                        <span class="text-green-600 ml-2" x-text="change.change || change.rationale"></span>
                                    </div>
                                </template>
                            </div>
                        </div>

                        <div class="prompt-display rounded-lg p-4 overflow-auto max-h-screen"
                             :class="{ 'optimized': showOptimizedPrompt }"
                             x-html="showOptimizedPrompt ? getOptimizedPromptHTML() : selectedAssistant.currentPrompt">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Progress Tab -->
            <div x-show="activeTab === 'progress'">
                <div x-show="!selectedAssistantId" class="text-center py-8 text-gray-500">
                    <span x-text="translations[language].selectAssistantFirst"></span>
                </div>

                <div x-show="selectedAssistantId">
                    <h2 class="text-xl font-semibold mb-4" x-text="translations[language].progressHistory"></h2>
                    <div class="bg-white p-4 rounded-lg">
                        <canvas id="progressChart" width="400" height="200"></canvas>
                    </div>

                    <!-- History Table -->
                    <div class="mt-6">
                        <h3 class="font-semibold mb-3" x-text="translations[language].historyDetails"></h3>
                        <div class="overflow-x-auto">
                            <table class="w-full border-collapse">
                                <thead>
                                    <tr class="bg-gray-100">
                                        <th class="border p-2 text-left" x-text="translations[language].date"></th>
                                        <th class="border p-2 text-left">QCI</th>
                                        <th class="border p-2 text-left" x-text="translations[language].calls"></th>
                                        <th class="border p-2 text-left" x-text="translations[language].recommendations"></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <template x-for="entry in assistantHistory" :key="entry.date">
                                        <tr class="hover:bg-gray-50 cursor-pointer" @click="loadRun(entry.runId)">
                                            <td class="border p-2" x-text="formatDate(entry.date)"></td>
                                            <td class="border p-2" x-text="entry.qci ? entry.qci.toFixed(1) : 'N/A'"></td>
                                            <td class="border p-2" x-text="entry.calls || 0"></td>
                                            <td class="border p-2" x-text="entry.recommendations ? entry.recommendations.join(', ') : 'None'"></td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function vapiDashboard() {
            return {
                // UI State
                activeTab: 'history',
                language: 'en',
                selectedAssistantId: '',
                showOptimizedPrompt: false,

                // Data
                runs: [],
                currentRun: {},
                assistants: [],
                selectedAssistant: null,
                assistantHistory: [],
                allRunData: {},

                // Translations
                translations: {
                    bg: {
                        title: 'VAPI ÐžÐ¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð½Ð° ÐŸÑ€Ð¾Ð¼Ð¿Ñ‚Ð¸',
                        historyTab: 'Ð˜ÑÑ‚Ð¾Ñ€Ð¸Ñ',
                        analyticsTab: 'ÐÐ½Ð°Ð»Ð¸Ñ‚Ð¸ÐºÐ°',
                        progressTab: 'ÐŸÑ€Ð¾Ð³Ñ€ÐµÑ',
                        runHistory: 'Ð˜ÑÑ‚Ð¾Ñ€Ð¸Ñ Ð½Ð° Ð—Ð°Ð¿ÑƒÑÐºÐ¸',
                        date: 'Ð”Ð°Ñ‚Ð°',
                        assistants: 'ÐÑÐ¸ÑÑ‚ÐµÐ½Ñ‚Ð¸',
                        calls: 'ÐžÐ±Ð°Ð¶Ð´Ð°Ð½Ð¸Ñ',
                        avgQCI: 'Ð¡Ñ€ÐµÐ´ÐµÐ½ QCI',
                        status: 'Ð¡Ñ‚Ð°Ñ‚ÑƒÑ',
                        noRuns: 'ÐÑÐ¼Ð° Ð½Ð°Ð»Ð¸Ñ‡Ð½Ð¸ Ð·Ð°Ð¿ÑƒÑÐºÐ¸',
                        selectRun: 'Ð˜Ð·Ð±ÐµÑ€ÐµÑ‚Ðµ Ð·Ð°Ð¿ÑƒÑÐº Ð¾Ñ‚ Ð˜ÑÑ‚Ð¾Ñ€Ð¸Ñ',
                        selectAssistant: 'Ð˜Ð·Ð±ÐµÑ€ÐµÑ‚Ðµ ÐÑÐ¸ÑÑ‚ÐµÐ½Ñ‚',
                        qciBreakdown: 'QCI Ð Ð°Ð·Ð±Ð¸Ð²ÐºÐ°',
                        callStats: 'Ð¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ°',
                        recommendations: 'ÐŸÑ€ÐµÐ¿Ð¾Ñ€ÑŠÐºÐ¸',
                        currentPrompt: 'Ð¢ÐµÐºÑƒÑ‰ ÐŸÑ€Ð¾Ð¼Ð¿Ñ‚',
                        optimizedPrompt: 'ÐžÐ¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð¸Ñ€Ð°Ð½ ÐŸÑ€Ð¾Ð¼Ð¿Ñ‚',
                        selectAssistantFirst: 'Ð˜Ð·Ð±ÐµÑ€ÐµÑ‚Ðµ Ð°ÑÐ¸ÑÑ‚ÐµÐ½Ñ‚ Ð¿ÑŠÑ€Ð²Ð¾',
                        progressHistory: 'Ð˜ÑÑ‚Ð¾Ñ€Ð¸Ñ Ð½Ð° ÐŸÑ€Ð¾Ð³Ñ€ÐµÑÐ°',
                        historyDetails: 'Ð”ÐµÑ‚Ð°Ð¹Ð»Ð¸',
                        totalCalls: 'ÐžÐ±Ñ‰Ð¾ ÐžÐ±Ð°Ð¶Ð´Ð°Ð½Ð¸Ñ',
                        successRate: 'Ð£ÑÐ¿ÐµÐ²Ð°ÐµÐ¼Ð¾ÑÑ‚',
                        analyzed: 'ÐÐ½Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð°Ð½Ð¾'
                    },
                    en: {
                        title: 'VAPI Prompt Optimization',
                        historyTab: 'History',
                        analyticsTab: 'Analytics',
                        progressTab: 'Progress',
                        runHistory: 'Run History',
                        date: 'Date',
                        assistants: 'Assistants',
                        calls: 'Calls',
                        avgQCI: 'Avg QCI',
                        status: 'Status',
                        noRuns: 'No runs available',
                        selectRun: 'Select a run from History',
                        selectAssistant: 'Select Assistant',
                        qciBreakdown: 'QCI Breakdown',
                        callStats: 'Call Statistics',
                        recommendations: 'Recommendations',
                        currentPrompt: 'Current Prompt',
                        optimizedPrompt: 'Optimized Prompt',
                        selectAssistantFirst: 'Select an assistant first',
                        progressHistory: 'Progress History',
                        historyDetails: 'History Details',
                        totalCalls: 'Total Calls',
                        successRate: 'Success Rate',
                        analyzed: 'Analyzed'
                    }
                },

                qciCategories: [
                    { name: 'Dynamics', key: 'dynamics' },
                    { name: 'Objections', key: 'objections' },
                    { name: 'Brand', key: 'brand' },
                    { name: 'Outcome', key: 'outcome' }
                ],

                // Assistant names mapping (from vapi_final_dashboard.html)
                assistantMapping: {
                    "8cd7551f-2ac8-441d-8f49-0abf053fb9b6": { "name": "Riley", "model": "gpt-4o" },
                    "35cd1a47-714b-4436-9a19-34d7f2d00b56": { "name": "BIESSE-MS", "model": "gpt-4o" },
                    "10f76383-d5aa-408d-9aca-3708bb9f8b22": { "name": "QC Advisor", "model": "gpt-4o" },
                    "24db494f-e25b-4a8f-a362-144b26ef2c86": { "name": "DTMF IVR Agent", "model": "gpt-4o" },
                    "55bb2539-5bbe-46c7-99bd-701eab22fbf1": { "name": "Inbound Call Center", "model": "gpt-4o" },
                    "163cc924-0e8c-45b1-b6cf-46e423885240": { "name": "Emanuela", "model": "gpt-4o" },
                    "613d30cd-0f98-4fcb-be3d-f39fee5c6406": { "name": "New Assistant", "model": "gpt-4o" },
                    "8e928338-22dc-42d1-b459-f4c52a6395f1": { "name": "Morgan 6 sec", "model": "gpt-4o" },
                    "1a9692a3-bc41-4d9f-b1db-a45170e9fbfe": { "name": "YC Assistant", "model": "gpt-4o-mini" },
                    "861f2ce7-fdee-401d-8554-29dada4725de": { "name": "Jacko", "model": "gpt-4o-mini" },
                    "8a51eae6-a29e-45c7-bea9-32c6d871e1bd": { "name": "Alex1", "model": "gpt-4o-mini" },
                    "0eddf4db-3bfa-4eb2-8053-082d94aa786d": { "name": "YC Assistant | HOT", "model": "gpt-4o" }
                },

                // Methods
                async init() {
                    this.language = localStorage.getItem('language') || 'en';
                    await this.loadManifest();
                },

                async loadManifest() {
                    try {
                        const response = await fetch('./data/manifest.json');
                        const manifest = await response.json();
                        this.runs = manifest.runs || [];

                        // Load latest run if available
                        if (manifest.latest) {
                            await this.loadRun(manifest.latest);
                        } else if (this.runs.length > 0) {
                            // If no latest specified, load the first run (most recent)
                            await this.loadRun(this.runs[0].id);
                        }
                    } catch (error) {
                        console.error('Error loading manifest:', error);
                        // Use fallback data for demo
                        this.loadFallbackData();

                        // Auto-load the latest fallback run
                        if (this.runs.length > 0) {
                            await this.loadRun(this.runs[0].id);
                        }
                    }
                },

                loadFallbackData() {
                    // REAL DATA from analysis results (updated with latest runs)
                    this.runs = [
                        {
                            "id": "2025-09-22_11-24-53",
                            "timestamp": "2025-09-22T11:24:53.000Z",
                            "assistants": 11,
                            "totalCalls": 1069,
                            "avgQCI": 0,
                            "status": "completed",
                            "duration": 508.9,
                            "cost": 0.5483
                        },
                        {
                            "id": "2025-09-22_10-42-48",
                            "timestamp": "2025-09-22T10:42:48.000Z",
                            "assistants": 7,
                            "totalCalls": 1069,
                            "avgQCI": 0,
                            "status": "completed",
                            "duration": 166.0,
                            "cost": 0.1886
                        },
                        {
                            "id": "2025-09-17_12-51-27",
                            "timestamp": "2025-09-17T12:51:27.600Z",
                            "assistants": 1,
                            "totalCalls": 14,
                            "avgQCI": 33.9,
                            "status": "completed",
                            "duration": 65.4,
                            "cost": 0.0494
                        }
                    ];

                    // REAL analysis data
                    this.allRunData = {
                        // Stub for newest runs - will be loaded from files
                        "2025-09-22_11-24-53": {},
                        "2025-09-22_10-42-48": {},
                        "2025-09-17_12-51-27": {
                            "id": "2025-09-17_12-51-27",
                            "timestamp": "2025-09-17T12:51:27.600Z",
                            "totalCalls": 14,
                            "assistants": {
                                "0eddf4db-3bfa-4eb2-8053-082d94aa786d": {
                                    "name": "YC Assistant | HOT",
                                    "qci": 33.9,
                                    "callCount": 14,
                                    "successRate": 7.1,
                                    "dynamics": 15.3,
                                    "objections": 4.4,
                                    "brand": 12.9,
                                    "outcome": 7.7,
                                    "targetQCI": 48.9,
                                    "recommendations": [
                                        {
                                            "priority": "HIGH PRIORITY",
                                            "title": "Fix Rigid Conversation Flow",
                                            "description": "Add conditional branching to adapt to caller responses. Expected +5 points in dynamics."
                                        },
                                        {
                                            "priority": "HIGH PRIORITY",
                                            "title": "Expand Objection Handling",
                                            "description": "Include empathy statements and alternative solutions. Expected +5 points in objections."
                                        },
                                        {
                                            "priority": "MEDIUM PRIORITY",
                                            "title": "Enhance Call-to-Action",
                                            "description": "Make language more direct and time-sensitive. Expected +5 points in outcome."
                                        }
                                    ],
                                    "currentPrompt": "######################################################################\nYOUNG CAESAR â€” WARM SDR AGENT WITH FAQ + FALLBACKS\n######################################################################\n\nFALLBACK RULES\nâ€¢ If {{bdr}} is empty â†’ say \"from Young Caesar.\"\nâ€¢ If {{company}} is empty â†’ skip mentioning the company.\nâ€¢ If 5 new clients for their Drilling machines every month is empty â†’ replace with \"new customers\" or \"new business.\"\nâ€¢ If Karl is empty â†’ open with \"Hey there, this is {{bdr}} from Young Caesarâ€¦\" instead of asking for their name.\nâ€¢ Never say \"empty\" or leave awkward pauses. Always use fallback phrases.\n\nTOOLS\nâ€¢ google_calendar_check_availability_tool â€” checks if a requested time is free on calendar\nâ€¢ google_calendar_tool â€” books the meeting using start, end, title, and email\nâ€¢ get_time_n8n â€” parses fuzzy times like \"next Tuesday at 2\" into structured start/end\nâ€¢ dtmf â€” use this for navigating menus, entering extensions, or automated prompts\n\nPERSONA\nYou're {{bdr}} from Young Caesar (fallback: \"from Young Caesar\").\nYou sound 100% human â€” calm, friendly, relaxed, never scripted.\nYou're following up with Karl (fallback: \"the person I emailed\"), who already replied to one of your emails about getting more 5 new clients for their Drilling machines every month clients (fallback: \"new customers\").\nYour role is to reconnect, confirm interest, handle objections, and book a short video call if they're open to it.\n\nSPEAKING STYLE\nâ€¢ Wait ~0.5â€“0.8 s of silence before speaking â€” never interrupt.\nâ€¢ Max 2 short sentences per turn, 1 question max.\nâ€¢ Use natural confirmations: \"Got it â€” thanks for that,\" \"Makes sense,\" \"Sure thing.\"\nâ€¢ Emphasize times, names, and emails clearly.\nâ€¢ If unclear, clarify naturally: \"Could you say that again so I get it right?\"\nâ€¢ Mirror caller's language if they switch; otherwise use plain English.\n\nTURN-TAKING & BACKCHANNEL FILTER\nâ€¢ Ignore short backchannels (\"yeah,\" \"ok,\" \"mm-hmm\") unless followed by a full sentence.\nâ€¢ Don't start a new topic after the caller says \"thank you\" or \"bye.\"\nâ€¢ Never repeat the same question unless asked.\n\nREPETITION AVOIDANCE\nDon't ask the same thing twice unless clarification is needed.\nIf they don't want a call, offer to email them and end gracefully.\n\nHUMAN TOUCH\nAlways pair confirmations with substance:\n- \"Gotcha â€” thanks for sharing that.\"\n- \"No worries â€” here's what I can do.\"\n- \"Appreciate you saying that.\"\n\n======================================================================\nWORD-SALAD FIREWALL\n======================================================================\nâ€¢ Speak only about 5 new clients for their Drilling machines every month (fallback: \"new customers\"), sales, scheduling, meetings, or contact info.\nâ€¢ Hard bans: invented words, random names, codes, or tool/log terms.\nâ€¢ SELF-CHECK before speaking:\n  (1) â‰¤ 2 sentences and â‰¤ 1 question\n  (2) nouns relevant to clients, meetings, contact, timing\n  (3) no invented proper nouns\n  (4) no gibberish\nâ€¢ FAIL-SAFE: if noisy or incoherent input, say:\n  \"Apologies â€” there was interference. Could you repeat the last part in one sentence?\"\n\n======================================================================\nCONNECTION REPAIR\n======================================================================\nIf caller says the line is choppy:\n\"Sorry, the line sounds rough. Should I call you back or keep it brief now?\"\n\n======================================================================\nHANDOFF MODE\n======================================================================\nIf asked to contact a colleague:\nCollect name, role, email, phone, timezone, and best time in one pass.\n\"Happy to call them. What's their name, role, email, phone, and a good time to reach them?\"\n\n======================================================================\nCONVERSATION GOALS\n======================================================================\n1. Verify who you're speaking to.\n2. Reference the prior email: \"I'm following up on the email exchange with {{bdr}} (fallback: 'our team at Young Caesar') about bringing in more 5 new clients for their Drilling machines every month clients (fallback: 'new customers').\"\n3. Confirm if they're still open to more customers.\n4. If yes â†’ confirm best email for invite.\n5. Ask for a time â†’ check calendar â†’ book call.\n6. Confirm meeting details out loud before ending.\n\n======================================================================\nCALL FLOW\n======================================================================\n\n1. OPENING\n\"Hey â€” am I speaking with Karl?\"  \nIf Karl empty â†’ \"Hey there, this is {{bdr}} from Young Caesar.\"\n\nâ€¢ If wrong person:  \n  \"No worries â€” do you know the best way to reach them? Maybe an email or direct line?\"  \n  If no help â†’ thank them and endCall.\n\nâ€¢ If automated menu â†’ follow with `dtmf`.\n\n2. EMAIL REFERENCE\n\"This is {{bdr}} from Young Caesar. We had an email exchange about helping you bring in more 5 new clients for their Drilling machines every month clients (fallback: 'new customers'). You replied, so I just wanted to follow up quickly.\"\n\n3. INTEREST OR HANDOFF\n\"Are you still open to discussing how to bring in more 5 new clients for their Drilling machines every month customers this quarter?\"\n\nâ€¢ If handoff â†’ HANDOFF MODE.  \nâ€¢ If not interested â†’ \"No worries â€” thanks for your time. Have a great day.\" â†’ endCall.\n\n4. EMAIL CONFIRMATION\n\"Cool â€” should we set a short 15-minute video call so I can show you exactly how we help?\"\nIf yes:  \n  - Ask: \"What's the best email for the invite?\"  \n  - If we already have peter.becker@flott.de: \"I've got peter.becker@flott.de here â€” is that still best, or another one?\"\n\n5. DEMO BOOKING\nAsk: \"What day and time works best for a quick call?\"\n\nâ†’ Step 1: `get_time_n8n` â†’ Step 2: `google_calendar_check_availability_tool` â†’ Step 3: `google_calendar_tool`.\n\nIf available: confirm booking out loud with date/time + email.  \nIf not available: \"That slot's taken â€” would another time work better?\"  \nIf still avoids: \"Totally makes sense â€” I'll send you a summary by email and we can revisit later.\" â†’ endCall.\n\n6. WRAP-UP\n\"Thanks Karl (fallback: just 'Thanks'). The invite's in your inbox. Looking forward to it!\"\n\n======================================================================\nOBJECTION & FAQ HANDLING\n======================================================================\nUse these mapped responses only when intent matches. Keep â‰¤2 sentences, then bridge back to booking.\n\nâ€¢ Open to new customers â†’ \"Great â€” let's book a 15-minute video call. What's your schedule like?\"\nâ€¢ What do you do â†’ \"We're a growth partner for manufacturers. We help you attract new customers consistently.\"\nâ€¢ How do you do it â†’ \"We identify people searching for 5 new clients for their Drilling machines every month (fallback: 'new business') and connect them with you. Easier to show on a call â€” would you be open to 15 minutes?\"\nâ€¢ Not interested â†’ \"Does that mean you're not looking for new customers, or just unsure about us? We even offer a free trial so you can see results.\"\nâ€¢ Customer name â†’ \"I can't share details over the phone, but happy to show you on a call. Would you like to schedule one?\"\nâ€¢ We don't want leads â†’ \"Totally understand â€” we don't sell lists. We connect you with real people actively searching.\"\nâ€¢ We have people doing that â†’ \"Got it â€” if you already have steady new customers every month, I won't take more of your time.\"\nâ€¢ Can't remember â†’ \"We exchanged emails about bringing in new clients for your 5 new clients for their Drilling machines every month. Just checking if you're still interested.\"\nâ€¢ Not the right person â†’ \"Thanks â€” could you share who would be the right person?\"\nâ€¢ Busy / vacation â†’ \"I get it. That's why I'm calling â€” we help busy professionals save time. When would be better to connect?\"\nâ€¢ Email me â†’ \"Happy to â€” but just curious, do you actually need new customers right now? If yes, we can guarantee that and set a call.\"\nâ€¢ How much â†’ \"Pricing depends on your setup. Best is to cover in a 15-minute call. We also offer a 60-day trial.\"\nâ€¢ Not an 5 new clients for their Drilling machines every month niche â†’ \"We've worked across many niches. Even if not direct, our process still brings in new customers.\"\nâ€¢ How are you different â†’ \"We focus only on manufacturers and guarantee results â€” or we don't get paid.\"\nâ€¢ Do you work commission â†’ \"No, different services at different costs, all with results guaranteed.\"\nâ€¢ Which countries â†’ \"We can bring you customers from anywhere. We've run campaigns worldwide.\"\nâ€¢ If asked about product knowledge â†’ \"Based on your website we believe we can help. On the call we'll ask clarifying questions to see how best to support you.\"\n\n======================================================================\nEND\n======================================================================",
                                    "optimizedPrompt": "######################################################################\nYOUNG CAESAR â€” WARM SDR AGENT WITH FAQ + FALLBACKS (OPTIMIZED)\n######################################################################\n\nFALLBACK RULES\nâ€¢ If {{bdr}} is empty â†’ say \"from Young Caesar.\"\nâ€¢ If {{company}} is empty â†’ skip mentioning the company.\nâ€¢ If 5 new clients for their Drilling machines every month is empty â†’ replace with \"new customers\" or \"new business.\"\nâ€¢ If Karl is empty â†’ open with \"Hey there, this is {{bdr}} from Young Caesarâ€¦\" instead of asking for their name.\nâ€¢ Never say \"empty\" or leave awkward pauses. Always use fallback phrases.\n\nTOOLS\nâ€¢ google_calendar_check_availability_tool â€” checks if a requested time is free on calendar\nâ€¢ google_calendar_tool â€” books the meeting using start, end, title, and email\nâ€¢ get_time_n8n â€” parses fuzzy times like \"next Tuesday at 2\" into structured start/end\nâ€¢ dtmf â€” use this for navigating menus, entering extensions, or automated prompts\n\nPERSONA\nYou're {{bdr}} from Young Caesar (fallback: \"from Young Caesar\").\nYou sound 100% human â€” calm, friendly, relaxed, never scripted.\nYou're following up with Karl (fallback: \"the person I emailed\"), who already replied to one of your emails about getting more 5 new clients for their Drilling machines every month clients (fallback: \"new customers\").\nYour role is to reconnect, confirm interest, handle objections, and book a short video call if they're open to it.\n\nSPEAKING STYLE\nâ€¢ Wait ~0.5â€“0.8 s of silence before speaking â€” never interrupt.\nâ€¢ Max 2 short sentences per turn, 1 question max.\nâ€¢ Use natural confirmations: \"Got it â€” thanks for that,\" \"Makes sense,\" \"Sure thing.\"\nâ€¢ Emphasize times, names, and emails clearly.\nâ€¢ If unclear, clarify naturally: \"Could you say that again so I get it right?\"\nâ€¢ Mirror caller's language if they switch; otherwise use plain English.\nâ€¢ <span class=\"changes-highlight\">ADAPTIVE FLOW: If caller seems hesitant, offer to send information via email first</span>\n\nTURN-TAKING & BACKCHANNEL FILTER\nâ€¢ Ignore short backchannels (\"yeah,\" \"ok,\" \"mm-hmm\") unless followed by a full sentence.\nâ€¢ Don't start a new topic after the caller says \"thank you\" or \"bye.\"\nâ€¢ Never repeat the same question unless asked.\n\nREPETITION AVOIDANCE\nDon't ask the same thing twice unless clarification is needed.\nIf they don't want a call, offer to email them and end gracefully.\n\nHUMAN TOUCH\nAlways pair confirmations with substance:\n- \"Gotcha â€” thanks for sharing that.\"\n- \"No worries â€” here's what I can do.\"\n- \"Appreciate you saying that.\"\n\n======================================================================\nWORD-SALAD FIREWALL\n======================================================================\nâ€¢ Speak only about 5 new clients for their Drilling machines every month (fallback: \"new customers\"), sales, scheduling, meetings, or contact info.\nâ€¢ Hard bans: invented words, random names, codes, or tool/log terms.\nâ€¢ SELF-CHECK before speaking:\n  (1) â‰¤ 2 sentences and â‰¤ 1 question\n  (2) nouns relevant to clients, meetings, contact, timing\n  (3) no invented proper nouns\n  (4) no gibberish\nâ€¢ FAIL-SAFE: if noisy or incoherent input, say:\n  \"Apologies â€” there was interference. Could you repeat the last part in one sentence?\"\n\n======================================================================\nCONNECTION REPAIR\n======================================================================\nIf caller says the line is choppy:\n\"Sorry, the line sounds rough. Should I call you back or keep it brief now?\"\n\n======================================================================\nHANDOFF MODE\n======================================================================\nIf asked to contact a colleague:\nCollect name, role, email, phone, timezone, and best time in one pass.\n\"Happy to call them. What's their name, role, email, phone, and a good time to reach them?\"\n\n======================================================================\nCONVERSATION GOALS\n======================================================================\n1. Verify who you're speaking to.\n2. Reference the prior email: \"I'm following up on the email exchange with {{bdr}} (fallback: 'our team at Young Caesar') about bringing in more 5 new clients for their Drilling machines every month clients (fallback: 'new customers').\"\n3. Confirm if they're still open to more customers.\n4. If yes â†’ confirm best email for invite.\n5. <span class=\"changes-highlight\">Ask for time with URGENCY: \"What day this week works best for a quick call?\"</span>\n6. Confirm meeting details out loud before ending.\n\n======================================================================\nCALL FLOW\n======================================================================\n\n1. OPENING\n\"Hey â€” am I speaking with Karl?\"\nIf Karl empty â†’ \"Hey there, this is {{bdr}} from Young Caesar.\"\n\nâ€¢ If wrong person:\n  \"No worries â€” do you know the best way to reach them? Maybe an email or direct line?\"\n  If no help â†’ thank them and endCall.\n\nâ€¢ If automated menu â†’ follow with dtmf.\n\n2. EMAIL REFERENCE\n\"This is {{bdr}} from Young Caesar. We had an email exchange about helping you bring in more 5 new clients for their Drilling machines every month clients (fallback: 'new customers'). You replied, so I just wanted to follow up quickly.\"\n\n3. INTEREST OR HANDOFF\n\"Are you still open to discussing how to bring in more 5 new clients for their Drilling machines every month customers this quarter?\"\n\nâ€¢ If handoff â†’ HANDOFF MODE.\nâ€¢ If not interested â†’ \"No worries â€” thanks for your time. Have a great day.\" â†’ endCall.\n\n4. EMAIL CONFIRMATION\n<span class=\"changes-highlight\">\"Perfect â€” let's set up a quick 15-minute video call this week so I can show you exactly how we help. Time-sensitive opportunities move fast in your industry.\"</span>\nIf yes:\n  - Ask: \"What's the best email for the invite?\"\n  - If we already have peter.becker@flott.de: \"I've got peter.becker@flott.de here â€” is that still best, or another one?\"\n\n5. DEMO BOOKING\nAsk: <span class=\"changes-highlight\">\"What day this week works best for a quick call? I have some great time slots available.\"</span>\n\nâ†’ Step 1: get_time_n8n â†’ Step 2: google_calendar_check_availability_tool â†’ Step 3: google_calendar_tool.\n\nIf available: confirm booking out loud with date/time + email.\nIf not available: \"That slot's taken â€” would another time work better?\"\n<span class=\"changes-highlight\">If still avoids: \"I understand you're busy. How about I send you a brief case study first, and we can schedule something next week that works better?\"</span>\n\n6. WRAP-UP\n\"Thanks Karl (fallback: just 'Thanks'). The invite's in your inbox. Looking forward to it!\"\n\n======================================================================\nOBJECTION & FAQ HANDLING (ENHANCED)\n======================================================================\nUse these mapped responses only when intent matches. Keep â‰¤2 sentences, then bridge back to booking.\n\nâ€¢ Open to new customers â†’ \"Great â€” let's book a 15-minute video call. What's your schedule like?\"\nâ€¢ What do you do â†’ \"We're a growth partner for manufacturers. We help you attract new customers consistently.\"\nâ€¢ How do you do it â†’ \"We identify people searching for 5 new clients for their Drilling machines every month (fallback: 'new business') and connect them with you. Easier to show on a call â€” would you be open to 15 minutes?\"\nâ€¢ <span class=\"changes-highlight\">Not interested â†’ \"I understand your concern, many of our clients felt the same way initially. Would it help if I shared a case study? We even offer a free trial so you can see results.\"</span>\nâ€¢ Customer name â†’ \"I can't share details over the phone, but happy to show you on a call. Would you like to schedule one?\"\nâ€¢ <span class=\"changes-highlight\">We don't want leads â†’ \"I completely understand â€” we don't sell lists either. We connect you with real people actively searching. Many clients were skeptical until they saw the quality.\"</span>\nâ€¢ We have people doing that â†’ \"Got it â€” if you already have steady new customers every month, I won't take more of your time.\"\nâ€¢ Can't remember â†’ \"We exchanged emails about bringing in new clients for your 5 new clients for their Drilling machines every month. Just checking if you're still interested.\"\nâ€¢ Not the right person â†’ \"Thanks â€” could you share who would be the right person?\"\nâ€¢ <span class=\"changes-highlight\">Busy / vacation â†’ \"I totally get it â€” that's exactly why I'm calling. We help busy professionals save time by bringing customers to you. When would be a better time to connect?\"</span>\nâ€¢ <span class=\"changes-highlight\">Email me â†’ \"Happy to send information â€” but I'm curious, do you actually need new customers right now? If yes, we can guarantee results and I'd love to set up just 15 minutes.\"</span>\nâ€¢ How much â†’ \"Pricing depends on your setup. Best is to cover in a 15-minute call. We also offer a 60-day trial.\"\nâ€¢ Not an 5 new clients for their Drilling machines every month niche â†’ \"We've worked across many niches. Even if not direct, our process still brings in new customers.\"\nâ€¢ How are you different â†’ \"We focus only on manufacturers and guarantee results â€” or we don't get paid.\"\nâ€¢ Do you work commission â†’ \"No, different services at different costs, all with results guaranteed.\"\nâ€¢ Which countries â†’ \"We can bring you customers from anywhere. We've run campaigns worldwide.\"\nâ€¢ If asked about product knowledge â†’ \"Based on your website we believe we can help. On the call we'll ask clarifying questions to see how best to support you.\"\n\n======================================================================\nEND\n======================================================================"
                                }
                            }
                        }
                    };

                    // Load latest run by default
                    this.processRunData(this.allRunData["2025-09-17_12-51-27"]);
                    // Switch to analytics tab automatically
                    this.activeTab = 'analytics';
                },

                async loadRun(runId) {
                    console.log('Loading run:', runId);

                    // First try to load from embedded data (for production/Vercel)
                    if (this.allRunData[runId] && Object.keys(this.allRunData[runId]).length > 0) {
                        console.log('Using embedded data for run:', runId);
                        this.processRunData(this.allRunData[runId]);
                        this.activeTab = 'analytics';
                        this.selectedAssistantId = '';
                        this.selectedAssistant = null;
                        return;
                    }

                    // Then try to load from file (for development)
                    try {
                        const response = await fetch(`./data/runs/${runId}.json`);
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        const data = await response.json();
                        console.log('Run data loaded from file:', data);
                        this.processRunData(data);
                        // Switch to analytics tab after loading data
                        this.activeTab = 'analytics';
                        // Reset assistant selection
                        this.selectedAssistantId = '';
                        this.selectedAssistant = null;
                    } catch (error) {
                        console.error('Error loading run from file:', error);
                        // For production, we should have all data embedded
                        console.error('No data available for run:', runId);
                        // Instead of alert, show a friendly message
                        this.currentRun = {
                            id: runId,
                            error: true,
                            message: 'Data for this run is being loaded...'
                        };
                        this.assistants = [];
                        this.activeTab = 'analytics';
                    }
                },

                processRunData(data) {
                    // Flexible data processing - adapts to any JSON structure
                    this.currentRun = this.extractRunMetadata(data);
                    this.assistants = this.extractAssistants(data);
                },

                extractRunMetadata(data) {
                    // Flexible extraction of run metadata
                    return {
                        id: data.id || data.runId || 'unknown',
                        timestamp: data.timestamp || data.date || new Date().toISOString(),
                        assistants: this.countAssistants(data),
                        totalCalls: this.countTotalCalls(data),
                        avgQCI: this.calculateAvgQCI(data)
                    };
                },

                extractAssistants(data) {
                    // Flexible assistant extraction
                    let assistants = [];

                    // Try different possible structures
                    if (data.assistants) {
                        assistants = Object.keys(data.assistants).map(id => ({
                            id,
                            ...data.assistants[id]
                        }));
                    } else if (data.recommendations) {
                        assistants = Object.keys(data.recommendations).map(id => {
                            // Get real name from mapping
                            const assistantInfo = this.assistantMapping[id];
                            const displayName = assistantInfo ? assistantInfo.name :
                                              (data.recommendations[id].assistant_name || `Assistant ${id.substr(0, 8)}`);

                            return {
                                id,
                                name: displayName,
                                ...data.recommendations[id],
                                // Extract optimized prompts from optimized_prompts section
                                currentPrompt: data.optimized_prompts?.[id]?.original_prompt || 'No prompt available',
                                optimizedPrompt: data.optimized_prompts?.[id]?.optimized_prompt || 'No optimized prompt available',
                                keyChanges: data.optimized_prompts?.[id]?.key_changes_made || []
                            };
                        });
                    } else if (Array.isArray(data)) {
                        assistants = data.map((item, index) => ({
                            id: item.id || item.assistant_id || index,
                            ...item
                        }));
                    }

                    return assistants;
                },

                countAssistants(data) {
                    if (data.assistants) return Object.keys(data.assistants).length;
                    if (data.recommendations) return Object.keys(data.recommendations).length;
                    if (Array.isArray(data)) return data.length;
                    return 0;
                },

                countTotalCalls(data) {
                    // Try to find total calls from various possible fields
                    return data.totalCalls || data.total_calls || data.calls || 0;
                },

                calculateAvgQCI(data) {
                    // Calculate average QCI from available data
                    let qciValues = [];

                    if (data.assistants) {
                        qciValues = Object.values(data.assistants)
                            .map(a => a.qci || a.currentQCI || a.qciScore)
                            .filter(v => v !== undefined && v !== null);
                    }

                    return qciValues.length > 0
                        ? qciValues.reduce((a, b) => a + b, 0) / qciValues.length
                        : 0;
                },

                loadAssistantDetails() {
                    this.selectedAssistant = this.assistants.find(a => a.id === this.selectedAssistantId);
                    if (this.selectedAssistant) {
                        this.loadAssistantHistory();
                    }
                },

                async loadAssistantHistory() {
                    try {
                        const response = await fetch('./data/assistant_timeline.json');
                        const timeline = await response.json();

                        if (timeline.assistants && timeline.assistants[this.selectedAssistantId]) {
                            this.assistantHistory = timeline.assistants[this.selectedAssistantId].history || [];
                            this.updateProgressChart();
                        }
                    } catch (error) {
                        console.error('Error loading assistant history:', error);
                        // Fallback demo history
                        this.loadDemoHistory();
                    }
                },

                loadDemoHistory() {
                    // REAL history - only one analysis run so far
                    const realHistories = {
                        "0eddf4db-3bfa-4eb2-8053-082d94aa786d": [
                            {
                                "runId": "2025-09-17_12-51-27",
                                "date": "2025-09-17",
                                "qci": 33.9,
                                "calls": 14,
                                "successRate": 7.1,
                                "recommendations": ["Fix rigid conversation flow", "Expand objection handling", "Enhance call-to-action"]
                            }
                        ]
                    };

                    this.assistantHistory = realHistories[this.selectedAssistantId] || [];
                    if (this.assistantHistory.length === 0) {
                        // Show message if no history for this assistant
                        console.log('No history available for assistant:', this.selectedAssistantId);
                    }
                    this.updateProgressChart();
                },

                updateProgressChart() {
                    if (this.assistantHistory.length === 0) return;

                    const ctx = document.getElementById('progressChart');
                    if (!ctx) return;

                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: this.assistantHistory.map(h => this.formatDate(h.date)),
                            datasets: [{
                                label: 'QCI Score',
                                data: this.assistantHistory.map(h => h.qci || 0),
                                borderColor: 'rgb(75, 192, 192)',
                                tension: 0.1
                            }]
                        },
                        options: {
                            responsive: true,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    max: 100
                                }
                            }
                        }
                    });
                },

                getQCIValue(key) {
                    if (!this.selectedAssistant) return 'N/A';
                    const value = this.selectedAssistant[key] || this.selectedAssistant.qciBreakdown?.[key];
                    return value ? value.toFixed(1) : 'N/A';
                },

                setLanguage(lang) {
                    this.language = lang;
                    localStorage.setItem('language', lang);
                },

                formatDate(dateString) {
                    if (!dateString) return 'N/A';
                    try {
                        return new Date(dateString).toLocaleDateString();
                    } catch {
                        return dateString;
                    }
                },

                getOptimizedPromptHTML() {
                    if (!this.selectedAssistant || !this.selectedAssistant.optimizedPrompt) return '';

                    let optimizedHTML = this.selectedAssistant.optimizedPrompt
                        .replace(/</g, '&lt;')
                        .replace(/>/g, '&gt;');

                    // Highlight key changes based on keyChanges data
                    if (this.selectedAssistant.keyChanges && this.selectedAssistant.keyChanges.length > 0) {
                        this.selectedAssistant.keyChanges.forEach(change => {
                            if (change.change) {
                                // Try to highlight the change in the optimized prompt
                                const changeText = change.change.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                                const regex = new RegExp(`(${changeText})`, 'gi');
                                optimizedHTML = optimizedHTML.replace(regex, '<span class="changes-highlight">$1</span>');
                            }
                        });
                    }

                    // Also handle existing span highlights
                    optimizedHTML = optimizedHTML
                        .replace(/&lt;span class=\"changes-highlight\"&gt;/g, '<span class="changes-highlight">')
                        .replace(/&lt;\/span&gt;/g, '</span>');

                    return optimizedHTML;
                },

                getRecommendations() {
                    if (!this.selectedAssistant || !this.selectedAssistant.recommendations) return [];

                    // Extract recommendations from Alex Hormozi framework
                    const recommendations = [];

                    if (this.selectedAssistant.recommendations.hormozi_recommendations) {
                        this.selectedAssistant.recommendations.hormozi_recommendations.forEach(rec => {
                            recommendations.push({
                                title: rec.title || rec.hormozi_principle || 'Recommendation',
                                description: rec.proposed_change || rec.current_value_equation || 'No description',
                                priority: rec.priority || 'MEDIUM'
                            });
                        });
                    }

                    return recommendations;
                },

                // Get display name for assistant
                getAssistantDisplayName(assistant) {
                    if (!assistant) return '';

                    const assistantInfo = this.assistantMapping[assistant.id];
                    if (assistantInfo) {
                        return assistantInfo.name;
                    }

                    // Fallback to existing name or ID
                    return assistant.name || assistant.id?.substring(0, 8) || 'Unknown';
                }
            }
        }
    </script>
</body>
</html>